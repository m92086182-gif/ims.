<!doctype html><html lang="ar" dir="rtl"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Admin - IMS</title><link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"><link rel="stylesheet" href="/css/style.css"><style>.range-item{display:inline-block;padding:6px 10px;margin:4px;border-radius:18px;background:#eef2ff;color:#1e293b}.range-item .del{margin-left:8px;color:#ef4444;cursor:pointer}</style></head><body class="p-4"><div class="container-fluid"><div class="d-flex justify-content-between align-items-center mb-3"><h2>لوحة التحكم</h2><div><button id="logoutBtn" class="btn btn-outline-secondary">تسجيل خروج</button></div></div><div class="row g-3"><div class="col-lg-4"><div class="card p-3 shadow-sm"><h5>إضافة دولة جديدة</h5><form id="addCountry"><input class="form-control mb-2" name="name" placeholder="اسم الدولة بالعربي" required><input class="form-control mb-2" name="code" placeholder="+966" required><button class="btn btn-success w-100">إضافة</button><div id="addMsg" class="mt-2 text-success"></div></form></div></div><div class="col-lg-8"><div class="card p-3 shadow-sm"><h5>إدارة الدول والرينجات</h5><div id="countriesManage"></div></div><div class="card p-3 shadow-sm mt-3"><h5>الطلبات</h5><div id="ordersContainer"></div></div></div></div></div><script src="/socket.io/socket.io.js"></script><script>const socket = io();async function loadCountriesManage(){const res=await fetch('/api/countries');const list=await res.json();const cont=document.getElementById('countriesManage');if(!list.length) return cont.innerHTML='<p class="text-muted">لا توجد دول</p>';cont.innerHTML=list.map(c=>`<div class="p-2 border rounded mb-2"><div class="d-flex justify-content-between align-items-center mb-2"><div><strong>${c.name}</strong> <span class="text-muted small">${c.code}</span></div><div><input class="form-control form-control-sm d-inline-block" id="r_inp_${c.id}" placeholder="أدخل رينج"/><button class="btn btn-sm btn-outline-primary ms-2 add-range" data-id="${c.id}">إضافة رينج</button></div></div><div id="ranges_${c.id}">${ (c.ranges||[]).map(r=>`<span class="range-item">${r}<span class="del" data-country="${c.id}" data-range="${r}">&times;</span></span>`).join('') }</div></div>`).join('');document.querySelectorAll('.add-range').forEach(b=>b.addEventListener('click', async (e)=>{const id=b.dataset.id;const val=document.getElementById('r_inp_'+id).value.trim();if(!val) return alert('أدخل رينج');const res=await fetch('/api/countries/'+id+'/ranges',{method:'POST',headers:{'content-type':'application/json'},body:JSON.stringify({range:val})});if(res.ok) loadCountriesManage();}));document.querySelectorAll('.del').forEach(d=>d.addEventListener('click', async (e)=>{const country=d.dataset.country;const range=d.dataset.range;const res=await fetch('/api/countries/'+country+'/ranges',{method:'DELETE',headers:{'content-type':'application/json'},body:JSON.stringify({range})});if(res.ok) loadCountriesManage();}));}async function loadOrders(){const res=await fetch('/api/orders'); if(!res.ok){document.getElementById('ordersContainer').innerHTML='<p class="text-danger">ممنوع</p>';return;}const list=await res.json();renderOrders(list);}function renderOrders(list){const cont=document.getElementById('ordersContainer');if(!list.length) return cont.innerHTML='<p class="text-muted">لا توجد طلبات حالياً.</p>';cont.innerHTML=list.map(o=>`<div class="d-flex align-items-center justify-content-between mb-2 p-2 border rounded"><div><strong>#${o.id}</strong> <span class="text-muted">[${o.type}]</span><div class="text-muted small">${o.createdAt}</div><div>${o.type==='number' ? 'دولة id: '+o.countryId+ ' - رينج: '+ (o.range||'بدون') + ' - عدد: '+ o.count : 'يوزر: '+ (o.fullname||'') }</div></div><div>${o.status==='pending' ? '<button class="btn btn-sm btn-primary exec" data-id="'+o.id+'">تنفيذ</button>' : '<span class="badge bg-success">منفذ</span>'}</div></div>`).join('');document.querySelectorAll('.exec').forEach(b=>b.addEventListener('click', async (e)=>{const id=e.target.dataset.id;const res=await fetch('/api/orders/'+id+'/execute',{method:'POST'});if(res.ok) loadOrders();}));}document.getElementById('addCountry').addEventListener('submit', async (e)=>{e.preventDefault();const fd=new FormData(e.target);const obj=Object.fromEntries(fd.entries());const res=await fetch('/api/countries',{method:'POST',headers:{'content-type':'application/json'},body:JSON.stringify(obj)});if(res.ok){document.getElementById('addMsg').textContent='تمت الإضافة';e.target.reset();loadCountriesManage();}});document.getElementById('logoutBtn').addEventListener('click', async ()=>{await fetch('/api/admin/logout',{method:'POST'});location.href='/';});socket.on('connect', ()=>{loadOrders();loadCountriesManage();});socket.on('newOrder', order => {loadOrders();alert('طلب جديد #'+order.id);});socket.on('orderExecuted', order => {loadOrders();alert('تم تنفيذ الطلب #'+order.id);});loadCountriesManage();loadOrders();</script></body></html>